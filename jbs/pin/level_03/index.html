<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Johren｜Level_03</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Johren の参加者ページです。">
  <!-- (paste the corrected CSS from above here) -->
</head>

<body>
  <div class="wrap">
    <div class="kicker">Welcome to Johren Adventure</div>
    <h1 id="merchantName">（参加者名）</h1>

    <div class="card">
      <div class="message">この場所は、参加できる場所です。</div>

      <div class="sub" style="margin-top:10px;">
        詳細は、現地でQRを読み取ると表示されます。
      </div>
      <div class="sub">Thanks for stopping by.</div>

      <div class="links">
        <a id="backLink" href="/jbs/map/">戻る →</a>
      </div>

      <div class="optional-link">
        <a id="merchantLink" href="#" aria-label="詳細を見る" style="display:none;">
          この参加者について、もう少し →
        </a>
      </div>

      <a id="infoLink" href="/setsumei/tenpo/"
         style="display:block;margin-top:12px;font-size:13px;color:#555;text-decoration:none;">
        この仕組みについて（店舗）→
      </a>
    </div>
  </div>

  <script>
    (async function () {
      const params = new URLSearchParams(location.search);
      const id = (params.get("id") || "").trim();

      if (!id) { location.replace("/jbs/map/"); return; }

      // merchant name
      try {
        const res = await fetch("/jbs/data/merchants.json", { cache: "no-store" });
        if (res.ok) {
          const merchants = await res.json();
          const m = merchants?.[id];
          const nameH1 = document.getElementById("merchantName");
          if (nameH1) nameH1.textContent = m?.name || "（参加者名）";
        }
      } catch (e) { console.error(e); }

      // links
      const back = document.getElementById("backLink");
      if (back) back.href = "/jbs/map/";

      const info = document.getElementById("infoLink");
      if (info) info.href = `/setsumei/tenpo/?id=${encodeURIComponent(id)}`;

      // merchant public link
      const merchantLink = document.getElementById("merchantLink");
      if (!merchantLink) return;

      try {
        const r = await fetch(`/.netlify/functions/merchant-link?id=${encodeURIComponent(id)}`, { cache: "no-store" });
        if (!r.ok) throw new Error("merchant-link failed: " + r.status);

        const j = await r.json();
        const url = (j?.url || "").trim();

        if (url) {
          merchantLink.href = url;
          merchantLink.target = "_blank";
          merchantLink.rel = "noopener noreferrer";
          merchantLink.style.display = "block";
        }
      } catch (e) { console.error(e); }
    })();
  </script>
</body>
</html>
