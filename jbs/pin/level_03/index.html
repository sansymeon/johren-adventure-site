<script>
(async function () {
  const params = new URLSearchParams(window.location.search);
  const id = (params.get("id") || "").trim();

  // Debug (optional): uncomment to verify query parsing
  // console.log("pin page id =", id);

  if (!id) return; // don’t redirect; just leave placeholder

  let merchants;
  try {
    const res = await fetch("/jbs/data/merchants.json", { cache: "no-store" });
    if (!res.ok) throw new Error("merchants.json fetch failed: " + res.status);
    merchants = await res.json();
  } catch (e) {
    console.error(e);
    const el = document.getElementById("merchantName");
    if (el) el.textContent = "（読み込みエラー）";
    return;
  }

  const m = merchants[id];

  // Set name
  const nameEl = document.getElementById("merchantName");
  if (nameEl) nameEl.textContent = (m && m.name) ? m.name : `（未登録: ${id}）`;

  // Back link (optional): preserve where they came from
  const back = document.getElementById("backLink");
  if (back) back.href = "/jbs/map/";

  // Info link: preserve id
  const info = document.getElementById("infoLink");
  if (info) info.href = `/setsumei/tenpo/?id=${encodeURIComponent(id)}`;

  // Merchant link: only if level 3
  const merchantLink = document.getElementById("merchantLink");
  if (merchantLink && m && m.level === 3) {
    merchantLink.href = `/jbs/qr/level_03_merchant/?id=${encodeURIComponent(id)}`;
    merchantLink.style.display = "block";
  }
})();
</script>
