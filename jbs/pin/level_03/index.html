<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Johren｜Level_03</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Johren の参加者ページです。">
  <!-- (paste the corrected CSS from above here) -->

  <style>
  body{
    margin:0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

    /* Subtle intentional background */
    background:
      url("/img/qrlanding_page_image.jpg") center / cover no-repeat,
      #f6f6f4;

    color:#222;
    line-height:1.7;
  }

  .kicker{
    font-size:14px;
    color:#777;
    margin:0 0 10px;
    letter-spacing:.2px;
  }

  .wrap{
    max-width:520px;
    margin:0 auto;
    padding:56px 20px 64px;
    text-align:center;
  }

  h1{
    font-size:1.35rem;
    margin:0 0 16px;
    letter-spacing:.2px;
  }

  .card{
    background:#fff;
    border:1px solid #ddd;
    border-radius:16px;
    padding:28px 24px;
    display:inline-block;
    width:100%;
    box-sizing:border-box;
  }

  .message{ font-size:15px; margin-bottom:18px; }
  .sub{ font-size:13px; color:#777; }

  .optional-link{ margin-top:22px; font-size:14px; }
  .optional-link a{
    color:#555;
    text-decoration:none;
    border-bottom:1px solid #ddd;
  }
  .optional-link a:hover{ color:#000; }

  .links{ margin-top:24px; font-size:13px; color:#666; }
  .links a{ color:#666; text-decoration:underline; }

    .jp { display:block; }
.en {
  display:block;
  font-size:12px;
  color:#777;
  margin-top:4px;
  line-height:1.4;
}
.kicker .en { font-size:11px; color:#888; margin-top:2px; }
.name-en { text-align:center; margin:6px 0 18px; }
.message .en { margin-top:6px; }

</style>

</head>

<body>
  <div class="wrap">
  <div class="kicker">
    <div class="jp">Johren Adventure</div>
  </div>

  <h1 id="merchantName">（参加者名）</h1>
  <div id="merchantNameEn" class="en name-en" style="display:none;"></div>

  <div class="card">
    <div class="message">
      <div class="jp">この場所は、参加できる場所です。</div>
      <div class="en">This place is participating.</div>
    </div>

    <div class="sub" style="margin-top:10px;">
      <div class="jp">詳細は、現地でQRを読み取ると表示されます。</div>
      <div class="en">More details appear when you scan the QR on-site.</div>
    </div>

    <div class="links">
      <a id="backLink" href="/jbs/map/">
        <span class="jp">戻る (Back) →</span>
      </a>
    </div>

    <div class="optional-link">
      <a id="merchantLink" href="#" aria-label="詳細を見る" style="display:none;">
        <span class="jp">この参加者について、もう少し (Shop Details) →</span>
      </a>
    </div>

    <a id="infoLink" href="/setsumei/tenpo/"
       style="display:block;margin-top:12px;text-decoration:none;">
      <span class="jp" style="font-size:13px;color:#555;">この仕組みについて（店舗）→</span>
      <span class="en" style="font-size:12px;color:#777;display:block;margin-top:2px;">How this works (for shops) →</span>
    </a>
  </div>
</div>


  <script>
(async function () {
  const params = new URLSearchParams(location.search);
  const id = (params.get("id") || "").trim();

  if (!id) { location.replace("/jbs/map/"); return; }

  // 1) Load merchants.json
  let merchants = null;
  try {
    const res = await fetch("/jbs/data/merchants.json", { cache: "no-store" });
    if (!res.ok) throw new Error("merchants.json fetch failed: " + res.status);
    merchants = await res.json();
  } catch (e) {
    console.error(e);
    location.replace("/jbs/map/");
    return;
  }

  const m = merchants?.[id];

  // 2) Enforce visibility + level BEFORE anything else
  if (!m || m.visible !== true || Number(m.level) < 3) {
    location.replace("/jbs/map/");
    return;
  }

  // 3) Populate names
  const nameH1 = document.getElementById("merchantName");
  if (nameH1) nameH1.textContent = m?.name || m?.nameEn || "（参加者名）";

  const nameEn = document.getElementById("merchantNameEn");
  if (nameEn) {
    const en = (m?.nameEn || "").trim();
    if (en) { nameEn.textContent = en; nameEn.style.display = "block"; }
  }

  // 4) Links
  const back = document.getElementById("backLink");
  if (back) back.href = "/jbs/map/";

  const info = document.getElementById("infoLink");
  if (info) info.href = `/setsumei/tenpo/?id=${encodeURIComponent(id)}`;

  // 5) Optional merchant public link from Supabase
  const merchantLink = document.getElementById("merchantLink");
  if (!merchantLink) return;

  try {
    const r = await fetch(`/.netlify/functions/merchant-link?id=${encodeURIComponent(id)}`, { cache: "no-store" });
    if (!r.ok) throw new Error("merchant-link failed: " + r.status);

    const j = await r.json();
    const url = (j?.url || "").trim();

    if (url) {
      merchantLink.href = url;
      merchantLink.target = "_blank";
      merchantLink.rel = "noopener noreferrer";
      merchantLink.style.display = "block";
    }
  } catch (e) {
    console.error(e);
  }
})();
</script>

</body>
</html>
