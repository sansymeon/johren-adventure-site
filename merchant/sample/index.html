<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Johren｜QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Johren に掲載された場所のQRコードです。">

  <style>
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#f7f7f7;
      color:#222;
      line-height:1.7;
    }
    .wrap{
      max-width:520px;
      margin:0 auto;
      padding:56px 20px 64px;
      text-align:center;
    }
    h1{
      font-size:1.35rem;
      margin:0 0 16px;
      letter-spacing:.2px;
    }
    .card{
      background:#fff;
      border:1px solid #ddd;
      border-radius:16px;
      padding:24px;
      display:inline-block;
    }
    .qr{
      width:180px;
      height:180px;
      display:block;
      margin:0 auto;
    }
    .qr:active{
      transform: scale(0.98);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>（店名）</h1>

    <div class="card">
      <a href="/start/" aria-label="Johren を開く" id="optin-link">
        <img
          src="/img/qr/merchant-qr.png"
          alt="Johren QRコード"
          class="qr"
        />
      </a>
    </div>
  </div>

  <!-- ✅ Opt-In logic (count + optional GPS) -->
  <script type="module">
    import {
      incrementOptInCountOncePerDay,
      saveOptInGPSContext
    } from "/js/storage.js";

    const link = document.getElementById("optin-link");

    if (link) {
      link.addEventListener("click", () => {
        const didCount = incrementOptInCountOncePerDay();

        if (didCount && navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              saveOptInGPSContext({
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                acc: pos.coords.accuracy
              });
            },
            () => {},
            {
              enableHighAccuracy: false,
              timeout: 3000,
              maximumAge: 60000
            }
          );
        }
      });
    }
  </script>

</body>
</html>
