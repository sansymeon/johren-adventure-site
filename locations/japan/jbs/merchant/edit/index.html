<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Johren｜リンク設定</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;background:#f6f6f4;color:#222;}
    .wrap{max-width:560px;margin:0 auto;padding:28px 18px 40px;}
    .card{background:#fff;border:1px solid #e2e2e2;border-radius:16px;padding:18px 16px;}
    h1{font-size:18px;margin:0 0 10px;}
    .muted{color:#666;font-size:13px;line-height:1.5;}
    label{display:block;margin:14px 0 6px;font-size:13px;color:#333;}
    input{width:100%;box-sizing:border-box;padding:12px 12px;border:1px solid #d6d6d6;border-radius:12px;font-size:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;}
    button{padding:11px 14px;border:0;border-radius:12px;background:#222;color:#fff;font-size:14px;cursor:pointer;}
    button.secondary{background:#e9e9e9;color:#222;}
    .status{margin-top:12px;font-size:13px;}
    .ok{color:#0a7a2f;}
    .ng{color:#b00020;}
    .tiny{font-size:12px;color:#777;margin-top:10px;line-height:1.5;}
    a{color:#333;text-decoration:underline;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>参加者リンクの設定</h1>
    <p class="muted">
      ここで設定したリンクは、Level 3 の参加者ページに表示されます。<br>
      ※ このページのURL（token付き）は外部に共有しないでください。
    </p>

    <div class="card">
      <div class="muted">参加者ID: <strong id="mid">—</strong></div>

      <label for="url">リンク先URL（https://〜）</label>
      <input id="url" type="url" placeholder="https://example.com" autocomplete="off" />

      <div class="row">
        <button id="saveBtn">保存</button>
        <button id="clearBtn" class="secondary">リンクを削除</button>
        <button id="testBtn" class="secondary">表示確認</button>
      </div>

      <div id="status" class="status muted"></div>
      <div class="tiny">
        推奨：HTTPS。<br>
        例：公式サイト、予約ページ、Instagramプロフィール等。<br>
        「表示確認」は Level 3 ピンページを開きます。
      </div>
    </div>
  </div>

<script>
(async function () {
  const qs = new URLSearchParams(location.search);
  const id = (qs.get("id") || "").trim();
  const token = (qs.get("token") || "").trim();

  const mid = document.getElementById("mid");
  const urlInput = document.getElementById("url");
  const status = document.getElementById("status");

  const saveBtn = document.getElementById("saveBtn");
  const clearBtn = document.getElementById("clearBtn");
  const testBtn = document.getElementById("testBtn");

  function setStatus(msg, ok=false){
    status.textContent = msg;
    status.className = "status " + (ok ? "ok" : "ng");
  }

  if (!id || !token) {
    mid.textContent = "（不明）";
    setStatus("URLに id と token が必要です。", false);
    saveBtn.disabled = true;
    clearBtn.disabled = true;
    testBtn.disabled = true;
    return;
  }

  mid.textContent = id;

  // Pre-fill current URL via GET (optional)
  try {
    const r = await fetch(`/.netlify/functions/merchant-link?id=${encodeURIComponent(id)}`, { cache: "no-store" });
    if (r.ok) {
      const j = await r.json();
      if (j && j.url) urlInput.value = j.url;
    }
  } catch (e) {}

  async function postUrl(newUrl){
    const payload = { id, token, url: newUrl };
    const r = await fetch("/.netlify/functions/merchant-link", {
      method: "POST",
      headers: { "content-type":"application/json" },
      body: JSON.stringify(payload)
    });
    const j = await r.json().catch(()=>null);
    if (!r.ok || !j?.ok) {
      throw new Error(j?.error || ("保存に失敗しました (" + r.status + ")"));
    }
    return j;
  }

  saveBtn.addEventListener("click", async () => {
    const u = (urlInput.value || "").trim();
    if (!u) { setStatus("URLを入力してください（または削除）。", false); return; }
    try {
      setStatus("保存中…", true);
      await postUrl(u);
      setStatus("保存しました。", true);
    } catch (e) {
      setStatus(e.message, false);
    }
  });

  clearBtn.addEventListener("click", async () => {
    try {
      setStatus("削除中…", true);
      await postUrl("");
      urlInput.value = "";
      setStatus("リンクを削除しました。", true);
    } catch (e) {
      setStatus(e.message, false);
    }
  });

  testBtn.addEventListener("click", () => {
    // open the Level 3 pin page for this merchant
    location.href = `/jbs/pin/level_03/?id=${encodeURIComponent(id)}`;
  });
})();
</script>
</body>
</html>
